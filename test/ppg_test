import cv2
import numpy as np
import matplotlib.pyplot as plt
import scipy.signal as signal

# Load the video file
cap = cv2.VideoCapture('20230216_220710.mp4')
fps = cap.get(cv2.CAP_PROP_FPS)

# Define the frequency range of the PPG signal
low_freq = 0.8
high_freq = 2.5

# Define an array to store the PPG signal values
ppg_signal = []

# Loop through each frame in the video
while cap.isOpened():
    # Read the next frame
    ret, frame = cap.read()
    if not ret:
        break

    # Display each frame
    cv2.imshow('video', frame)
    
    # Convert the frame to grayscale
    gray = cv2.cvtColor(frame, cv2.COLOR_BGR2GRAY)

    # Apply a bandpass filter to extract the PPG frequency range
    b, a = signal.butter(3, [2 * low_freq / fps, 2 * high_freq / fps], btype='band')
    filtered_gray = signal.filtfilt(b, a, gray)

    # Calculate the mean pixel intensity in the frequency range
    ppg_value = np.mean(filtered_gray)

    # Store the PPG signal value in the array
    ppg_signal.append(ppg_value)

# Release the video capture
cap.release()

# Plot the PPG signal
plt.plot(ppg_signal)
plt.show()
